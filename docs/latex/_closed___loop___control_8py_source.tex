\doxysection{Closed\+\_\+\+Loop\+\_\+\+Control.\+py}
\hypertarget{_closed___loop___control_8py_source}{}\label{_closed___loop___control_8py_source}\index{Lab Final/Files On Romi/Closed\_Loop\_Control.py@{Lab Final/Files On Romi/Closed\_Loop\_Control.py}}
\mbox{\hyperlink{_closed___loop___control_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00001}00001\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00016}00016\ \textcolor{keyword}{from}\ math\ \textcolor{keyword}{import}\ copysign}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00024}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control}{00024}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control}{ClosedLoopControl}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00026}00026\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00041}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa89aca6d34821d9829a583a49173e1f3}{00041}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa89aca6d34821d9829a583a49173e1f3}{\_\_init\_\_}}(}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ self,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ sensor,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ max\_min:\ float\ =\ 100,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ Kp:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ Ki:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ Kd:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ Kw:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00049}00049\ \ \ \ \ \ \ \ \ Kff:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ PWM\_start:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00051}00051\ \ \ \ \ \ \ \ \ battery=\textcolor{keywordtype}{None},}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00052}00052\ \ \ \ \ ):}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00053}00053\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ac3b27a7a6f30b5c0f36fd4dfd8743326}{sensor}}\ =\ sensor}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00054}00054\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_abb8512f3b3f49b5fc309bb60200f9e7a}{max\_min}}\ =\ max\_min}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00055}00055\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ab6ae3f050641b67f2541decb8fbb6c6f}{battery}}\ =\ battery}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00057}00057\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ @brief\ Gains}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a406e8e11787e9934d388532642da8090}{Kp}}\ =\ Kp}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af48234a52ccabdbcd66677a5910a867b}{Ki}}\ =\ Ki}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a42b5b0355b09e8d751050ab403506fc0}{Kd}}\ =\ Kd}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00061}00061\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af0626545ac77094f36c753ca6ceba206}{Kw}}\ =\ Kw}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00062}00062\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0dbdffad84c06801b52a1f6bdf12958c}{Kff}}\ =\ Kff}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00063}00063\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a78d8eb6ca8c73a1fb550c4385cf0336c}{PWM\_start}}\ =\ PWM\_start}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00064}00064\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00065}00065\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Inputs\ \&\ Outputs}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00066}00066\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}}\ =\ 0\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Reference\ /\ setpoint}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00067}00067\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a81954c460645556024a030752fb24b46}{x\_h}}\ =\ 0\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Measured\ value}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00068}00068\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa8718d9fb4b9f82854489870ed42210d}{a}}\ =\ 0\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Raw\ actuation\ value}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00069}00069\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a49a491ae59a2f2a0bb6f15e494c2c4b0}{astar}}\ =\ 0\ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Saturated\ actuation\ value}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00070}00070\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00071}00071\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Internal\ controller\ states}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00072}00072\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}\ =\ 0\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Error}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00073}00073\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a14465388d3a7ee676ad952b546404d02}{prev\_error}}\ =\ 0\ \ \ \textcolor{comment}{\#\ Previous\ cycle\ error}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00074}00074\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0972ef4544f2b33df947cb58f6becf22}{integral}}\ =\ 0\ \ \ \ \ \textcolor{comment}{\#\ Integral\ accumulator}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00075}00075\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a875c3110a261d5de5b56d0dc6ad75611}{derivative}}\ =\ 0\ \ \ \textcolor{comment}{\#\ Derivative\ term}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Soft-\/start\ ramping}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a99e44b4eb13279f22fbca8846893a8e2}{on}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a798df1d3fe2d0dd0f3dea5332c770750}{first\_run}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a67e8a8eb7ac7be688a0526d3b12cf2c1}{num\_corrections}}\ =\ 75}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af54ef54bb55c9f33fd834fee799c96ff}{total\_num\_corrections}}\ =\ 200}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00082}00082\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00083}00083\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00086}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_afa1f942294a85e304bf8d73279a80e02}{00086}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_afa1f942294a85e304bf8d73279a80e02}{reset}}(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00087}00087\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00088}00088\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00089}00089\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a14465388d3a7ee676ad952b546404d02}{prev\_error}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0972ef4544f2b33df947cb58f6becf22}{integral}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00091}00091\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a875c3110a261d5de5b56d0dc6ad75611}{derivative}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a798df1d3fe2d0dd0f3dea5332c770750}{first\_run}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a67e8a8eb7ac7be688a0526d3b12cf2c1}{num\_corrections}}\ =\ 75}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00094}00094\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00095}00095\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00098}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aebb3d324c6fade3ecffb58764d6f52fb}{00098}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aebb3d324c6fade3ecffb58764d6f52fb}{set\_ref}}(self,\ speed)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}}\ =\ speed}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00100}00100\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00101}00101\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00102}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a2058e62e1b3f8f85b526ed66463d5ba4}{00102}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a2058e62e1b3f8f85b526ed66463d5ba4}{disable}}(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00103}00103\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a99e44b4eb13279f22fbca8846893a8e2}{on}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00105}00105\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00106}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a1035044a2b4ce0d9a0f43168c22548d6}{00106}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a1035044a2b4ce0d9a0f43168c22548d6}{enable}}(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00107}00107\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a99e44b4eb13279f22fbca8846893a8e2}{on}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00108}00108\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00109}00109\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00119}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a95aa8ea640bd1a855a21b43d69f888fd}{00119}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a95aa8ea640bd1a855a21b43d69f888fd}{gain\_update}}(}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00120}00120\ \ \ \ \ \ \ \ \ self,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00121}00121\ \ \ \ \ \ \ \ \ Kp:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00122}00122\ \ \ \ \ \ \ \ \ Ki:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ Kd:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00124}00124\ \ \ \ \ \ \ \ \ Kw:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00125}00125\ \ \ \ \ \ \ \ \ Kff:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ PWM\_start:\ float\ =\ 0,}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00127}00127\ \ \ \ \ ):}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a406e8e11787e9934d388532642da8090}{Kp}}\ =\ Kp}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00129}00129\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af48234a52ccabdbcd66677a5910a867b}{Ki}}\ =\ Ki}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00130}00130\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a42b5b0355b09e8d751050ab403506fc0}{Kd}}\ =\ Kd}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00131}00131\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af0626545ac77094f36c753ca6ceba206}{Kw}}\ =\ Kw}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0dbdffad84c06801b52a1f6bdf12958c}{Kff}}\ =\ Kff}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a78d8eb6ca8c73a1fb550c4385cf0336c}{PWM\_start}}\ =\ PWM\_start}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00134}00134\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00135}00135\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00148}\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a53878544c99ca0962748a1b88101db3c}{00148}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a53878544c99ca0962748a1b88101db3c}{run}}(self):}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00149}00149\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a99e44b4eb13279f22fbca8846893a8e2}{on}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00151}00151\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Soft-\/start\ reference\ ramping}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a67e8a8eb7ac7be688a0526d3b12cf2c1}{num\_corrections}}\ >\ 0:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa36df9588b05e7a51c950cabb6726f7c}{r\_u}}\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}}\ *\ ((self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af54ef54bb55c9f33fd834fee799c96ff}{total\_num\_corrections}}\ -\/\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a67e8a8eb7ac7be688a0526d3b12cf2c1}{num\_corrections}})}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ /\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af54ef54bb55c9f33fd834fee799c96ff}{total\_num\_corrections}})}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a67e8a8eb7ac7be688a0526d3b12cf2c1}{num\_corrections}}\ -\/=\ 1}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa36df9588b05e7a51c950cabb6726f7c}{r\_u}}\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00159}00159\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Get\ current\ measured\ value}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a81954c460645556024a030752fb24b46}{x\_h}}\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ac3b27a7a6f30b5c0f36fd4dfd8743326}{sensor}}.get\_data()}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00162}00162\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Error\ update}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a14465388d3a7ee676ad952b546404d02}{prev\_error}}\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa36df9588b05e7a51c950cabb6726f7c}{r\_u}}\ -\/\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a81954c460645556024a030752fb24b46}{x\_h}}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00166}00166\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Compute\ timing\ delta\ in\ seconds}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ time\_delta\ =\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ac3b27a7a6f30b5c0f36fd4dfd8743326}{sensor}}.dt\ /\ 1e6}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a798df1d3fe2d0dd0f3dea5332c770750}{first\_run}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \ \ \ \ time\_delta\ =\ 0.020\ \ \ \textcolor{comment}{\#\ Approx.\ first-\/cycle\ assumption}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00171}00171\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Integral\ and\ derivative\ updates}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00173}00173\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af48234a52ccabdbcd66677a5910a867b}{Ki}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0972ef4544f2b33df947cb58f6becf22}{integral}}\ +=\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}\ *\ time\_delta}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a42b5b0355b09e8d751050ab403506fc0}{Kd}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a875c3110a261d5de5b56d0dc6ad75611}{derivative}}\ =\ (self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}}\ -\/\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a14465388d3a7ee676ad952b546404d02}{prev\_error}})\ /\ time\_delta}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00177}00177\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Battery\ droop\ compensation}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ab6ae3f050641b67f2541decb8fbb6c6f}{battery}}\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ \ \ \ \ Kdroop\ =\ 1\ /\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ab6ae3f050641b67f2541decb8fbb6c6f}{battery}}.get\_cur\_perc()}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ \ \ \ \ Kdroop\ =\ 1}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00183}00183\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Controller\ output}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa8718d9fb4b9f82854489870ed42210d}{a}}\ =\ Kdroop\ *\ (}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00186}00186\ \ \ \ \ \ \ \ \ \ \ \ \ (self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a406e8e11787e9934d388532642da8090}{Kp}}\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_ae462ea541c0cc1d4ed89b7cb432b5659}{e}})\ +}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \ \ \ (self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0972ef4544f2b33df947cb58f6becf22}{integral}}\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af48234a52ccabdbcd66677a5910a867b}{Ki}})\ +}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00188}00188\ \ \ \ \ \ \ \ \ \ \ \ \ (self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a875c3110a261d5de5b56d0dc6ad75611}{derivative}}\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a42b5b0355b09e8d751050ab403506fc0}{Kd}})\ +}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00189}00189\ \ \ \ \ \ \ \ \ \ \ \ \ ((self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa36df9588b05e7a51c950cabb6726f7c}{r\_u}}\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0dbdffad84c06801b52a1f6bdf12958c}{Kff}})\ +\ copysign(1,\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a8a44db904cf3b50763c7fc4a6567b81d}{r}})\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a78d8eb6ca8c73a1fb550c4385cf0336c}{PWM\_start}})}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00190}00190\ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00191}00191\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00192}00192\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Saturation}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00193}00193\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a49a491ae59a2f2a0bb6f15e494c2c4b0}{astar}}\ =\ min(self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_abb8512f3b3f49b5fc309bb60200f9e7a}{max\_min}},\ max(-\/self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_abb8512f3b3f49b5fc309bb60200f9e7a}{max\_min}},\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa8718d9fb4b9f82854489870ed42210d}{a}}))}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00194}00194\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00195}00195\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Anti-\/windup\ correction}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00196}00196\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af0626545ac77094f36c753ca6ceba206}{Kw}}:}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a0972ef4544f2b33df947cb58f6becf22}{integral}}\ -\/=\ (self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_aa8718d9fb4b9f82854489870ed42210d}{a}}\ -\/\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a49a491ae59a2f2a0bb6f15e494c2c4b0}{astar}})\ *\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_af0626545ac77094f36c753ca6ceba206}{Kw}}}
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00198}00198\ }
\DoxyCodeLine{\Hypertarget{_closed___loop___control_8py_source_l00199}00199\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ self.\mbox{\hyperlink{class_closed___loop___control_1_1_closed_loop_control_a49a491ae59a2f2a0bb6f15e494c2c4b0}{astar}}}

\end{DoxyCode}
